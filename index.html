<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manoj Nehra | Official Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        :root { --primary: #6366f1; --glass: rgba(255, 255, 255, 0.08); --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%); }
        body { background: var(--bg-gradient); color: #f8fafc; font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; padding-bottom: 120px; user-select: none; }
        
        /* IMAGE SIZE FIXES */
        #main-app { max-width: 600px; margin: 0 auto; }
        img { max-width: 100%; height: auto; }
        .carousel-item img { height: 180px; object-fit: cover; width: 100%; border-radius: 20px; }
        .test-card-img { width: 100%; height: 140px; object-fit: cover; border-radius: 15px; margin-bottom: 12px; }
        /* Question Image Specific Fix */
        #q-text img { display: block; margin: 10px auto; max-height: 250px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); }

        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.15); border-radius: 25px; padding: 22px; margin-bottom: 18px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .nav-dock { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(15, 23, 42, 0.95); border-radius: 30px; display: flex; justify-content: space-around; padding: 10px 5px; z-index: 8000; border: 1px solid rgba(255,255,255,0.15); }
        .nav-link-3d { color: rgba(255,255,255,0.4); text-decoration: none; text-align: center; flex: 1; font-size: 0.7rem; cursor: pointer; }
        .nav-link-3d.active { color: var(--primary); transform: translateY(-5px); text-shadow: 0 0 10px var(--primary); }
        .nav-link-3d i { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        .btn-premium { background: linear-gradient(135deg, var(--primary), #8b5cf6); border: none; color: white; padding: 8px 18px; border-radius: 12px; font-weight: 700; font-size: 0.8rem; }
        
        .page { display: none; } .page.active { display: block; animation: fadeInUp 0.4s ease-out; }
        #exam-overlay, #testListOverlay, #result-overlay { display: none; position: fixed; inset: 0; background: #020617; z-index: 9999; flex-direction: column; overflow-y:auto; }
        .opt-btn { text-align: left; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; width: 100%; color: white; margin-bottom: 10px; }
        .opt-btn.selected { background: var(--primary); border-color: white; }
        .auth-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; padding: 10px; width: 100%; margin-bottom: 10px; outline: none; }
        
        /* SCORE CARD CSS */
        .stat-box { border-right: 1px solid rgba(255,255,255,0.1); padding: 5px; }
        .stat-box:last-child { border-right: none; }
        .stat-val { font-size: 1.2rem; font-weight: 800; }
        .review-card { border-left: 5px solid #6366f1; background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .review-card.correct { border-color: #22c55e; } .review-card.wrong { border-color: #ef4444; }
        .lock-icon { opacity: 0.5; filter: grayscale(1); }
        @media(min-width: 768px) { .carousel-item img { height: 350px; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="auth-screen" style="position:fixed; inset:0; background:#020617; z-index:9000; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div class="glass-card text-center" style="width: 90%; max-width: 380px;">
            <img src="https://i.ibb.co/5GzXk7j/user.png" style="width: 90px; height:90px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 15px; object-fit:cover;">
            <h3 class="fw-800 mb-4">MANOJ NEHRA</h3>
            
            <div id="signup-box">
                <input type="text" id="su-name" placeholder="Full Name" class="auth-input">
                <input type="email" id="su-email" placeholder="Email Address" class="auth-input">
                <input type="password" id="su-pass" placeholder="Password (Min 6 chars)" class="auth-input">
                <button onclick="doSignup()" class="btn btn-primary w-100 rounded-pill py-2 mt-2 fw-bold">Sign Up</button>
                <p class="mt-3 small opacity-75">Already have an account? <span onclick="showLogin()" class="text-primary fw-bold cursor-pointer" style="cursor:pointer;">Login Name</span></p>
            </div>

            <div id="login-box" style="display:none;">
                <input type="email" id="li-email" placeholder="Email Address" class="auth-input">
                <input type="password" id="li-pass" placeholder="Password" class="auth-input">
                <button onclick="doLogin()" class="btn btn-success w-100 rounded-pill py-2 mt-2 fw-bold">Login</button>
                <p class="mt-3 small opacity-75">New user? <span onclick="showSignup()" class="text-success fw-bold cursor-pointer" style="cursor:pointer;">Signup Name</span></p>
            </div>
            <p id="auth-error" class="text-danger mt-3 small" style="display:none;"></p>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <header class="container pt-4">
            <div class="d-flex align-items-center gap-2">
                <img src="https://i.ibb.co/5GzXk7j/user.png" style="width:40px; height:40px; border-radius: 50%;">
                <div class="d-flex flex-column">
                    <h6 class="fw-bold mb-0">MANOJ NEHRA</h6>
                    <div id="user-display-name" class="small text-info fw-bold">Student</div>
                </div>
            </div>
        </header>

        <div class="container mt-2">
            <div id="homePage" class="page active">
                <div id="homeSlider" class="carousel slide mb-4 rounded-4 shadow" data-bs-ride="carousel"><div class="carousel-inner" id="slider-box"></div></div>
                <div class="py-3"><h3 class="fw-800">Premium Notes</h3></div>
                <div id="notesGrid" class="row g-3"></div>
            </div>
            <div id="testSeriesPage" class="page">
                <div class="py-3 text-center"><h3 class="fw-800">Online Test Series</h3></div>
                <div id="testSeriesGrid" class="row g-3"></div>
            </div>
            <div id="purchasePage" class="page pt-3">
                <h3 class="text-center mb-4">मेरी लाइब्रेरी</h3>
                <h6 class="text-indigo-500 mb-3"><i class="fas fa-book me-2"></i>खरीदे गए नोट्स</h6>
                <div id="myNotesGrid" class="mb-4"></div>
                <h6 class="text-indigo-500 mb-3"><i class="fas fa-edit me-2"></i>खरीदी गई टेस्ट सीरीज</h6>
                <div id="myTestsGrid"></div>
            </div>
            <div id="profilePage" class="page">
                <div class="glass-card text-center mt-4">
                    <img id="u-img" src="" class="rounded-circle mb-3 shadow" style="width: 80px; height:80px; border: 3px solid var(--primary); object-fit:cover;">
                    <h4 id="u-name">Student</h4>
                    <button class="btn btn-danger w-100 py-2 mt-4" onclick="logout()">Logout Account</button>
                </div>
            </div>
        </div>

        <nav class="nav-dock">
            <div class="nav-link-3d active" onclick="showPage('homePage', this)"><i class="fas fa-home"></i>Home</div>
            <div class="nav-link-3d" onclick="showPage('testSeriesPage', this)"><i class="fas fa-edit"></i>Tests</div>
            <div class="nav-link-3d" onclick="showPage('purchasePage', this)"><i class="fas fa-bookmark"></i>Library</div>
            <div class="nav-link-3d" onclick="showPage('profilePage', this)"><i class="fas fa-user"></i>Profile</div>
        </nav>
    </div>

    <div id="testListOverlay" class="p-4">
        <button onclick="closeTestList()" class="btn btn-sm btn-outline-light mb-3"><i class="fa fa-arrow-left"></i> Back</button>
        <div class="d-flex justify-content-between align-items-center mb-3 p-3 rounded" style="background: rgba(255,255,255,0.1)"><div><small>Total Score</small><h4 id="global-score-text" class="fw-bold mb-0">****</h4></div><button onclick="toggleGlobalScore()" class="btn btn-sm btn-light rounded-pill px-3"><i id="score-toggle-icon" class="fa fa-eye-slash"></i></button></div>
        <h2 id="current-series-title" class="text-center mb-4 fs-5"></h2>
        <div id="test-list-container" class="container"></div>
    </div>

    <div id="exam-overlay">
        <header class="p-3 bg-dark d-flex justify-content-between"><span id="exam-timer" class="text-danger fw-bold fs-4">60:00</span><button onclick="finishExam()" class="btn btn-success">SUBMIT</button></header>
        <div class="flex-grow-1 container d-flex align-items-center justify-content-center">
            <div class="glass-card w-100" style="max-width: 600px;">
                <p id="q-num" class="text-primary fw-bold small mb-2"></p>
                <div id="q-text" class="mb-4"></div>
                <div id="opt-box"></div>
                <div class="d-flex justify-content-between mt-4"><button onclick="prevQ()" class="btn btn-outline-light">Prev</button><button onclick="nextQ()" class="btn btn-primary">Next</button></div>
            </div>
        </div>
    </div>

    <div id="result-overlay" class="p-4">
        <button onclick="closeReview()" class="btn btn-sm btn-outline-light mb-4"><i class="fa fa-arrow-left"></i> Home</button>
        <div class="glass-card text-center mb-3 border-success p-0 overflow-hidden">
            <div class="p-4"><small class="opacity-75">FINAL SCORE</small><h1 class="fw-bold display-3 my-2" id="res-score">00</h1></div>
            <div class="d-flex border-top border-secondary">
                <div class="flex-fill stat-box py-3"><div class="text-success stat-val" id="r-right">0</div><small>Right</small></div>
                <div class="flex-fill stat-box py-3"><div class="text-danger stat-val" id="r-wrong">0</div><small>Wrong</small></div>
                <div class="flex-fill stat-box py-3"><div class="text-warning stat-val" id="r-neg">0</div><small>-Neg</small></div>
            </div>
        </div>
        <button onclick="showReviewAnswerKey()" class="btn btn-primary w-100 mb-3 fw-bold">REVIEW ANSWERS</button>
        <div id="review-container" class="container mt-2" style="display:none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAhg7hKJ123JRAfio7fymK543XpuNonMHo", authDomain: "showpdf-ffa34.firebaseapp.com", databaseURL: "https://showpdf-ffa34-default-rtdb.firebaseio.com", projectId: "showpdf-ffa34" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app);

        // AUTH
        window.showLogin=()=>{document.getElementById('signup-box').style.display='none';document.getElementById('login-box').style.display='block'};
        window.showSignup=()=>{document.getElementById('login-box').style.display='none';document.getElementById('signup-box').style.display='block'};
        window.doSignup=()=>{createUserWithEmailAndPassword(auth,document.getElementById('su-email').value,document.getElementById('su-pass').value).then(res=>updateProfile(res.user,{displayName:document.getElementById('su-name').value})).catch(e=>document.getElementById('auth-error').innerText=e.message)};
        window.doLogin=()=>{signInWithEmailAndPassword(auth,document.getElementById('li-email').value,document.getElementById('li-pass').value).catch(e=>alert(e.message))};
        window.logout=()=>{signOut(auth).then(()=>location.reload())};

        let currentExamQs=[], userAnswers=[], qIdx=0, examTimer, activeSeriesId="", activeTestIdx=0, curPos=1, curRatio=3, globalScoreHidden=true;

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('auth-screen').style.display='none'; document.getElementById('main-app').style.display='block';
                document.getElementById('u-name').innerText=user.displayName; document.getElementById('user-display-name').innerText=user.displayName;
                loadNotes(); loadTestSeries(); loadSlider();
            } else { document.getElementById('auth-screen').style.display='flex'; }
        });

        // LOADERS
        function loadSlider(){ onValue(ref(db, 'appSlider'),s=>{ const b=document.getElementById('slider-box');b.innerHTML="";let f=true;s.forEach(c=>{b.innerHTML+=`<div class="carousel-item ${f?'active':''}"><img src="${c.val().image}"></div>`;f=false}) }); }
        async function loadNotes(){ onValue(ref(db, `users/${auth.currentUser.uid}/purchases/notes`), s=>{ const p=s.val()||{}; const n=[{id:"note1",title:"Notes PDF",price:49}]; let h=''; n.forEach(x=>{h+=`<div class="col-12"><div class="glass-card d-flex justify-content-between"><h6>${x.title}</h6><button class="btn-premium" onclick="${p[x.id]?.paid?`alert('Open')`:`buyTest('${x.id}',${x.price})`}">${p[x.id]?.paid?'Open':'₹'+x.price}</button></div></div>`}); document.getElementById('notesGrid').innerHTML=h; }); }
        function loadTestSeries(){ onValue(ref(db, 'testSeries'), async s=>{ const d=s.val();if(!d)return; const pSnap=await get(ref(db,`users/${auth.currentUser.uid}/purchases/tests`));const p=pSnap.val()||{}; const g=document.getElementById('testSeriesGrid'),l=document.getElementById('myTestsGrid'); g.innerHTML="";l.innerHTML=""; Object.keys(d).forEach(k=>{ const x=d[k];const pd=p[k]?.paid; g.innerHTML+=`<div class="col-6 col-md-4"><div class="glass-card text-center p-2"><img src="${x.image}" class="test-card-img"><h6 class="small fw-bold">${x.title}</h6><button onclick="handleAction('${k}',${x.price},'${x.title}')" class="btn-premium w-100 mt-2">${pd?'Open':'₹'+x.price}</button></div></div>`; if(pd)l.innerHTML+=`<div class="glass-card d-flex justify-content-between"><h6>${x.title}</h6><button onclick="openTestList('${k}','${x.title}')" class="btn btn-sm btn-primary">VIEW</button></div>`; }); }); }
        
        window.handleAction=async(id,pr,ti)=>{const s=await get(ref(db,`users/${auth.currentUser.uid}/purchases/tests/${id}`));if(s.exists()&&s.val().paid)openTestList(id,ti);else new Razorpay({key:"rzp_live_Ry7zglI0OnE1Jo",amount:pr*100,name:"Exam",handler:async()=>{await set(ref(db,`users/${auth.currentUser.uid}/purchases/tests/${id}`),{paid:true});loadTestSeries()}}).open()};
        window.toggleGlobalScore=()=>{globalScoreHidden=!globalScoreHidden;document.getElementById('global-score-text').innerText=globalScoreHidden?"****":"Shown"};

        // LIST & EXAM (DATE FIX + UI FIX)
        window.openTestList = async (id, title) => {
            activeSeriesId=id; document.getElementById('testListOverlay').style.display='flex'; document.getElementById('current-series-title').innerText=title;
            const s=await get(ref(db, `testSeries/${id}`)); 
            let t=[]; try{t=JSON.parse(s.val().questions)}catch(e){t=[]}
            curPos=s.val().posMarks||1; curRatio=s.val().negRatio||3;
            const p=await get(ref(db, `users/${auth.currentUser.uid}/testResults/${id}`)); const r=p.val()||{};
            const b=document.getElementById('test-list-container'); b.innerHTML=""; const today=new Date().setHours(0,0,0,0);

            t.forEach((item,i)=>{ 
                let name=`Test ${i+1}`, cnt=0, dLock=false, dStr="";
                if(item.questions && Array.isArray(item.questions)){
                    name=item.name||name; cnt=item.questions.length;
                    if(item.unlockDate){ const d=new Date(item.unlockDate).setHours(0,0,0,0); if(today<d){dLock=true;dStr=item.unlockDate} }
                } else cnt=item.length;

                const c=r[i]!==undefined, l=i>0&&r[i-1]===undefined;
                let btn="START", cls="btn-primary", dis="";
                if(c) btn="RETEST"; 
                else if(dLock) {btn="Coming "+dStr; cls="btn-secondary"; dis="disabled"}
                else if(l) {btn="LOCK"; cls="btn-secondary"; dis="disabled"}

                b.innerHTML+=`<div class="glass-card d-flex justify-content-between align-items-center ${(l||dLock)?'lock-icon':''}"><div><b>${name}</b><br><small>${cnt} Qs ${c?`| Score: ${r[i].toFixed(2)}`:''}</small></div><button class="btn ${cls} btn-sm rounded-pill" onclick="${dis?'':`startExam('${id}',${i})`}" ${dis}>${btn}</button></div>`;
            });
        };
        window.closeTestList=()=>document.getElementById('testListOverlay').style.display='none';

        window.startExam = async (sid, idx) => {
            activeTestIdx=idx; const snap=await get(ref(db, `testSeries/${sid}`)); const raw=JSON.parse(snap.val().questions);
            let dm=60; 
            if(raw[idx].questions){currentExamQs=raw[idx].questions; dm=parseInt(raw[idx].duration)||60} else {currentExamQs=raw[idx]}
            userAnswers=new Array(currentExamQs.length).fill(null); qIdx=0;
            document.getElementById('testListOverlay').style.display='none'; document.getElementById('exam-overlay').style.display='flex'; renderQuestion();
            clearInterval(examTimer); examTimer=setInterval(()=>{dm--;document.getElementById('exam-timer').innerText=dm+"m";if(dm<=0)finishExam()},60000);
        };

        function renderQuestion(){
            const q=currentExamQs[qIdx]; document.getElementById('q-num').innerText=`Q${qIdx+1}`;
            document.getElementById('q-text').innerHTML=q.q+(q.img?`<img src="${q.img}">`:'');
            const b=document.getElementById('opt-box');b.innerHTML="";
            q.options.forEach((o,i)=>b.innerHTML+=`<button onclick="selOpt(${i})" class="opt-btn ${userAnswers[qIdx]===o?'selected':''}">${o}</button>`);
        }
        window.selOpt=(i)=>{userAnswers[qIdx]=currentExamQs[qIdx].options[i];renderQuestion()};
        window.nextQ=()=>{if(qIdx<currentExamQs.length-1){qIdx++;renderQuestion()}};
        window.prevQ=()=>{if(qIdx>0){qIdx--;renderQuestion()}};

        window.finishExam=async()=>{
            clearInterval(examTimer);document.getElementById('exam-overlay').style.display='none';
            let c=0,w=0; currentExamQs.forEach((q,i)=>{if(userAnswers[i]===q.ans)c++;else if(userAnswers[i])w++});
            const marks=(c*curPos)-(w*(curPos/curRatio));
            await set(ref(db, `users/${auth.currentUser.uid}/testResults/${activeSeriesId}/${activeTestIdx}`), marks);
            document.getElementById('res-score').innerText=marks.toFixed(2);
            document.getElementById('r-right').innerText=c; document.getElementById('r-wrong').innerText=w; document.getElementById('r-neg').innerText=((w*curPos/curRatio)).toFixed(2);
            document.getElementById('result-overlay').style.display='block'; document.getElementById('review-container').style.display='none';
        };
        window.showReviewAnswerKey=()=>{
            const b=document.getElementById('review-container');b.innerHTML="";b.style.display='block';
            currentExamQs.forEach((q,i)=>{b.innerHTML+=`<div class="review-card ${userAnswers[i]===q.ans?'correct':'wrong'}"><b>Q${i+1}</b> ${q.q}<br><small>Your: ${userAnswers[i]||'-'}</small><br><small class="text-success">Ans: ${q.ans}</small></div>`});
        };
        window.closeReview=()=>{document.getElementById('result-overlay').style.display='none';openTestList(activeSeriesId,"Test")};
        window.showPage=(id,e)=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active')};
    </script>
</body>
</html>
